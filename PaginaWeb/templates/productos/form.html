{% extends "base.html" %}
{% block content %}

<div class="page-header">
    <h1>{{ titulo }}</h1>
    <a href="{% url 'productos_lista' %}" class="btn-secondary">Volver</a>
</div>

<div class="form-card">

    <h3>Datos del Producto</h3>

    <form method="post" class="product-form">
        {% csrf_token %}

        <!-- FILA 1 -->
        <div class="form-row">

            <div class="form-group">
                <label>Código</label>
                <input type="text" name="codigo"
                       id="codigo"
                       value="{{ producto.codigo|default:'' }}"
                       required>
            </div>

            <div class="form-group">
                <label>Nombre</label>
                <input type="text" name="nombre"
                       id="nombre"
                       value="{{ producto.nombre|default:'' }}"
                       required>
            </div>

        </div>

        <!-- FILA 2 -->
        <div class="form-row">

            <!-- UNIDAD BASE -->
            <div class="form-group">
                <label>Unidad Base</label>

                <select name="unidad_base" id="unidad_base" required>
                    <option value="">Seleccione...</option>

                    {% for u in unidades %}
                        <option value="{{ u.id }}"
                            {% if producto and producto.unidad_base and producto.unidad_base.id == u.id %}
                                selected
                            {% endif %}
                        >
                            {{ u.nombre }}
                        </option>
                    {% endfor %}
                </select>

                <small style="opacity:0.7">
                    Es la unidad oficial del producto: kilo, unidad, caja, manojo…
                </small>
            </div>

            <!-- STOCK MINIMO -->
            <div class="form-group">
                <label>Stock mínimo</label>
                <input type="number" step="0.01" min="0"
                       name="stock_minimo"
                       value="{{ producto.stock_minimo|default:'' }}"
                       required>
            </div>

        </div>

        <!-- FILA 3 -->
        <div class="form-row">

            <div class="form-group full-width">
                <label>Descripción</label>
                <textarea name="descripcion" id="descripcion" rows="3">{{ producto.descripcion|default:'' }}</textarea>
            </div>

        </div>

        <!-- PREVISUALIZACIÓN -->
        <div class="form-row">
            <div class="form-group full-width">
                <label>Vista previa del nombre final</label>
                <input type="text" id="preview"
                       disabled
                       style="opacity:0.65; font-weight:600;">
            </div>
        </div>

        <!-- ACCIONES -->
        <div class="form-actions">
            <a href="{% url 'productos_lista' %}" class="btn-secondary">Cancelar</a>
            <button type="submit" class="btn-primary">Guardar</button>
        </div>

    </form>

</div>


<script>
document.addEventListener("DOMContentLoaded", function () {

    const form = document.querySelector("form");
    const nombreInput = document.getElementById("nombre");
    const unidadSelect = document.getElementById("unidad_base");
    const preview = document.getElementById("preview");

    // Detecta si el nombre ya tiene "(algo)" y devuelve solo el nombre base
    function limpiarNombre(nombre) {
        return nombre.replace(/\s*\(.*?\)\s*$/, "").trim();
    }

    function pluralizar(txt) {
        txt = txt.toLowerCase().trim();
        if (txt.endsWith("a")) return txt + "s";
        if (txt.endsWith("o")) return txt + "s";
        if (txt.endsWith("e")) return txt + "s";
        if (txt.endsWith("l")) return txt + "es";
        if (txt.endsWith("r")) return txt + "es";
        return txt;
    }

    function capitalizar(txt) {
        return txt.charAt(0).toUpperCase() + txt.slice(1);
    }

    function generarNombreFinal() {
        let nombreBase = limpiarNombre(nombreInput.value.trim());
        const unidad = unidadSelect.options[unidadSelect.selectedIndex]?.text || "";

        if (!nombreBase || unidad === "Seleccione...") {
            return nombreBase;
        }

        const unidadPlural = pluralizar(unidad);
        return `${capitalizar(nombreBase)} (${unidadPlural})`;
    }

    function updatePreview() {
        preview.value = generarNombreFinal();
    }

    nombreInput.addEventListener("input", updatePreview);
    unidadSelect.addEventListener("change", updatePreview);

    // Cuando cargamos la página, limpiamos el nombre mostrado
    nombreInput.value = limpiarNombre(nombreInput.value.trim());
    updatePreview();

    // ✔ Al enviar el formulario, se guarda correctamente el nombre final SIN duplicados
    form.addEventListener("submit", function () {
        nombreInput.value = generarNombreFinal();
    });

});
</script>

{% endblock %}
